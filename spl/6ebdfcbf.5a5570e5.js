(window.webpackJsonp=window.webpackJsonp||[]).push([[10],{147:function(e,t,a){"use strict";a.r(t),a.d(t,"frontMatter",(function(){return s})),a.d(t,"metadata",(function(){return i})),a.d(t,"rightToc",(function(){return l})),a.d(t,"default",(function(){return p}));var n=a(2),o=a(9),r=(a(0),a(155)),s={title:"Stake Pool Program"},i={id:"stake-pool",isDocsHomePage:!1,title:"Stake Pool Program",description:"A program for pooling together SOL to be staked by an off-chain agent running",source:"@site/src/stake-pool.md",permalink:"/solana-program-library/spl/stake-pool",sidebar:"docs",previous:{title:"Shared memory Program",permalink:"/solana-program-library/spl/shared-memory"},next:{title:"Feature Proposal Program",permalink:"/solana-program-library/spl/feature-proposal"}},l=[{value:"Overview",id:"overview",children:[]},{value:"Quick Start",id:"quick-start",children:[]},{value:"Motivation",id:"motivation",children:[]},{value:"Operation",id:"operation",children:[{value:"Fees",id:"fees",children:[]},{value:"Funding restrictions",id:"funding-restrictions",children:[]}]},{value:"Background",id:"background",children:[]},{value:"Source",id:"source",children:[]},{value:"Security Audits",id:"security-audits",children:[]},{value:"Command-line Utility",id:"command-line-utility",children:[{value:"Configuration",id:"configuration",children:[]}]},{value:"Stake Pool Manager Examples",id:"stake-pool-manager-examples",children:[{value:"Create a stake pool",id:"create-a-stake-pool",children:[]},{value:"Create a restricted stake pool",id:"create-a-restricted-stake-pool",children:[]},{value:"Set manager",id:"set-manager",children:[]},{value:"Set fee",id:"set-fee",children:[]},{value:"Set referral fee",id:"set-referral-fee",children:[]},{value:"Set staker",id:"set-staker",children:[]},{value:"Set Funding Authority",id:"set-funding-authority",children:[]}]},{value:"Stake Pool Staker Examples",id:"stake-pool-staker-examples",children:[{value:"Add a validator to the pool",id:"add-a-validator-to-the-pool",children:[]},{value:"Remove validator stake account",id:"remove-validator-stake-account",children:[]},{value:"Rebalance the stake pool",id:"rebalance-the-stake-pool",children:[]},{value:"Set Preferred Deposit / Withdraw Validator",id:"set-preferred-deposit--withdraw-validator",children:[]}]},{value:"User Examples",id:"user-examples",children:[{value:"List validator stake accounts",id:"list-validator-stake-accounts",children:[]},{value:"Deposit SOL",id:"deposit-sol",children:[]},{value:"Withdraw SOL",id:"withdraw-sol",children:[]},{value:"Deposit stake",id:"deposit-stake",children:[]},{value:"Update",id:"update",children:[]},{value:"Withdraw stake",id:"withdraw-stake",children:[]}]},{value:"Appendix",id:"appendix",children:[{value:"Activated stakes",id:"activated-stakes",children:[]},{value:"Transient stake accounts",id:"transient-stake-accounts",children:[]},{value:"Reserve stake account",id:"reserve-stake-account",children:[]},{value:"Safety of Funds",id:"safety-of-funds",children:[]},{value:"Transaction sizes",id:"transaction-sizes",children:[]}]}],c={rightToc:l};function p(e){var t=e.components,a=Object(o.a)(e,["components"]);return Object(r.b)("wrapper",Object(n.a)({},c,a,{components:t,mdxType:"MDXLayout"}),Object(r.b)("p",null,"A program for pooling together SOL to be staked by an off-chain agent running\na Delegation Bot which redistributes the stakes across the network and tries\nto maximize censorship resistance and rewards."),Object(r.b)("h2",{id:"overview"},"Overview"),Object(r.b)("p",null,"SOL token holders can earn rewards and help secure the network by staking tokens\nto one or more validators. Rewards for staked tokens are based on the current\ninflation rate, total number of SOL staked on the network, and an individual\nvalidator\u2019s uptime and commission (fee)."),Object(r.b)("p",null,"Stake pools are an alternative method of earning staking rewards. This on-chain\nprogram pools together SOL to be staked by a staker, allowing SOL holders to\nstake and earn rewards without managing stakes."),Object(r.b)("p",null,"Additional information regarding staking and stake programming is available at:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",Object(n.a)({parentName:"li"},{href:"https://solana.com/staking"}),"https://solana.com/staking")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",Object(n.a)({parentName:"li"},{href:"https://docs.solana.com/staking/stake-programming"}),"https://docs.solana.com/staking/stake-programming"))),Object(r.b)("h2",{id:"quick-start"},"Quick Start"),Object(r.b)("p",null,"If you're looking to get immediately into creating and running a stake pool,\ntake a look at the\n",Object(r.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/solana-labs/solana-program-library/tree/master/stake-pool/cli/scripts"}),"reference scripts"),"."),Object(r.b)("p",null,"These scripts require the Solana CLI tool suite, which can be downloaded by\nfollowing the instructions at (",Object(r.b)("a",Object(n.a)({parentName:"p"},{href:"https://docs.solana.com/cli/install-solana-cli-tools"}),"https://docs.solana.com/cli/install-solana-cli-tools"),").\nAdditionally, you must have a usable keypair, created at the default location\nusing ",Object(r.b)("inlineCode",{parentName:"p"},"solana-keygen new"),"."),Object(r.b)("p",null,"You'll see the following scripts:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"setup-local.sh"),": sets up a local test validator with validator vote accounts"),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"setup-stake-pool.sh"),": creates a new stake pool with hardcoded parameters"),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"deposit-withdraw.sh"),": performs some deposits and withdrawals")),Object(r.b)("p",null,"The\n",Object(r.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/solana-labs/solana-program-library/tree/master/stake-pool/cli"}),"CLI README"),"\ncontains more information about each of these scripts."),Object(r.b)("h2",{id:"motivation"},"Motivation"),Object(r.b)("p",null,"This document is intended for the main actors of the stake pool system:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"manager: creates and manages the stake pool, earns fees, can update the fee, staker, and manager"),Object(r.b)("li",{parentName:"ul"},"staker: adds and removes validators to the pool, rebalances stake among validators"),Object(r.b)("li",{parentName:"ul"},"user: provides staked SOL into an existing stake pool")),Object(r.b)("p",null,"In its current iteration, the stake pool accepts active stakes or SOL, so\ndeposits may come from either an active stake or SOL wallet. Withdrawals\ncan return a fully active stake account from one of the stake pool's accounts,\nor SOL from the reserve."),Object(r.b)("p",null,"This means that stake pool managers and stakers must be comfortable with\ncreating and delegating stakes, which are more advanced operations than sending and\nreceiving SPL tokens and SOL. Additional information on stake operations are\navailable at:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",Object(n.a)({parentName:"li"},{href:"https://docs.solana.com/cli/delegate-stake"}),"https://docs.solana.com/cli/delegate-stake")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",Object(n.a)({parentName:"li"},{href:"https://docs.solana.com/cli/manage-stake-accounts"}),"https://docs.solana.com/cli/manage-stake-accounts"))),Object(r.b)("p",null,"To reach a wider audience of users, stake pool managers are encouraged\nto provide a market for their pool's tokens, through an AMM\nlike ",Object(r.b)("a",Object(n.a)({parentName:"p"},{href:"/solana-program-library/spl/token-swap"}),"Token Swap"),"."),Object(r.b)("p",null,"Alternatively, stake pool managers can partner with wallet and stake account\nproviders for direct SOL deposits."),Object(r.b)("h2",{id:"operation"},"Operation"),Object(r.b)("p",null,'A stake pool manager creates a stake pool, and the staker includes validators that will\nreceive delegations from the pool by adding "validator stake accounts" to the pool\nusing the ',Object(r.b)("inlineCode",{parentName:"p"},"add-validator")," instruction. In this command, the stake pool creates\na new stake account and delegates it to the desired validator."),Object(r.b)("p",null,"At this point, users can participate with deposits. They can directly deposit\nSOL into the stake pool using the ",Object(r.b)("inlineCode",{parentName:"p"},"deposit-sol")," instruction. Within this instruction,\nthe stake pool will move SOL into the pool's reserve account, to be redistributed\nby the staker."),Object(r.b)("p",null,"Alternatively, users can deposit a stake account into the pool.  To do this,\nthey must delegate a stake account to the one of the validators in the stake pool.\nIf the stake pool has a preferred deposit validator, the user must delegate their\nstake to that validator's vote account."),Object(r.b)("p",null,"Once the stake becomes active, which happens at the following epoch boundary\n(maximum 2 days), the user can deposit their stake into the pool using the\n",Object(r.b)("inlineCode",{parentName:"p"},"deposit-stake")," instruction."),Object(r.b)("p",null,"In exchange for their deposit (SOL or stake), the user receives SPL tokens\nrepresenting their fractional ownership in pool. A percentage of the rewards\nearned by the pool goes to the pool manager as an epoch fee."),Object(r.b)("p",null,"Over time, as the stakes in the pool accrue rewards, the user's fractional\nownership will be worth more than their initial deposit."),Object(r.b)("p",null,"Whenever they wish to exit the pool, the user may use the ",Object(r.b)("inlineCode",{parentName:"p"},"withdraw-sol")," instruction\nto receive SOL from the stake pool's reserve in exchange for stake pool tokens.\nNote that this operation will fail if there is not enough SOL in the stake pool's\nreserve, which is normal if the stake pool manager stakes all of the SOL in the pool."),Object(r.b)("p",null,"Alternatively, they can use the ",Object(r.b)("inlineCode",{parentName:"p"},"withdraw-stake")," instruction to withdraw an\nactivated stake account in exchange for their SPL pool tokens. The user will get\nback a SOL stake account immediately. The ability to withdraw stake is always\npossible, under all circumstances."),Object(r.b)("p",null,"Note: when withdrawing stake, if the user wants to withdraw the SOL in the stake\naccount, they must first deactivate the stake account and wait until the next\nepoch boundary (maximum 2 days).  Once the stake is inactive, they can freely\nwithdraw the SOL."),Object(r.b)("p",null,"The stake pool staker can add and remove validators, or rebalance the pool by\ndecreasing the stake on a validator, waiting an epoch to move it into the stake\npool's reserve account, then increasing the stake on another validator."),Object(r.b)("p",null,"The staker operation to add a new validator requires 0.00328288 SOL to create\nthe stake account on a validator, so the stake pool staker will need liquidity\non hand to fully manage the pool stakes.  The SOL used to add a new validator\nis recovered when removing the validator."),Object(r.b)("h3",{id:"fees"},"Fees"),Object(r.b)("p",null,"The stake pool program provides managers many options for making the pool\nfinancially viable, predominantly through fees. There are five different sources\nof fees:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"Epoch: every epoch (roughly 2 days), the stake accounts in the pool earn\ninflation rewards, so the stake pool mints pool tokens into the manager's fee\naccount as a proportion of the earned rewards. For example, if the pool earns\n10 SOL in rewards, and the fee is set to 2%, the manager will earn pool tokens\nworth 0.2 SOL."),Object(r.b)("li",{parentName:"ul"},"SOL withdraw: sends a proportion of the desired withdrawal amount to the manager\nFor example, if a user wishes to withdraw 100 pool tokens, and the fee is set\nto 3%, 3 pool tokens go to the manager, and the remaining 97 tokens go to the\nuser in the form of a SOL."),Object(r.b)("li",{parentName:"ul"},"Stake withdraw: sends a proportion of the desired withdrawal amount to the manager\nbefore creating a new stake for the user."),Object(r.b)("li",{parentName:"ul"},"SOL deposit: converts the entire SOL deposit into pool tokens, then sends a\nproportion of those to the manager, and the rest to the user"),Object(r.b)("li",{parentName:"ul"},"Stake deposit: converts the stake account's delegation plus rent-exemption\nto pool tokens, sends a proportion of those to the manager, and the rest to\nthe user")),Object(r.b)("p",null,"For partner applications, there's the option of a referral fee on deposits.\nDuring SOL or stake deposits, the stake pool can redistribute a percentage of\nthe fees to another address as a referral fee."),Object(r.b)("p",null,"This option is particularly attractive for wallet providers. When a wallet\nintegrates a stake pool, the wallet developer will have the option to earn\nadditional tokens anytime a user deposits into the stake pool. Stake pool\nmanagers can use this feature to create strategic partnerships and entice\ngreater adoption of stake pools!"),Object(r.b)("h3",{id:"funding-restrictions"},"Funding restrictions"),Object(r.b)("p",null,'To give the manager more control over funds entering the pool, stake pools allow\ndeposit and withdrawal restrictions on SOL and stakes through three different\n"funding authorities":'),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"SOL deposit"),Object(r.b)("li",{parentName:"ul"},"Stake deposit"),Object(r.b)("li",{parentName:"ul"},"SOL withdrawal")),Object(r.b)("p",null,"If the field is set, that authority must sign the associated instruction."),Object(r.b)("p",null,"For example, if the manager sets a stake deposit authority, then that address\nmust sign every stake deposit instruction."),Object(r.b)("p",null,"This can also be useful in a few situations:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"Control who deposits into the stake pool"),Object(r.b)("li",{parentName:"ul"},"Prohibit a form of deposit. For example, the manager only wishes to have SOL\ndeposits, so they set a stake deposit authority, making it only possible to\ndeposit a stake account if that authority signs the transaction."),Object(r.b)("li",{parentName:"ul"},"Maintenance mode. If the pool needs time to reset fees or otherwise, the\nmanager can temporarily restrict new deposits by setting deposit authorities.")),Object(r.b)("p",null,"Note: in order to keep user funds safe, stake withdrawals are always permitted."),Object(r.b)("h2",{id:"background"},"Background"),Object(r.b)("p",null,"Solana's programming model and the definitions of the Solana terms used in this\ndocument are available at:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",Object(n.a)({parentName:"li"},{href:"https://docs.solana.com/apps"}),"https://docs.solana.com/apps")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",Object(n.a)({parentName:"li"},{href:"https://docs.solana.com/terminology"}),"https://docs.solana.com/terminology"))),Object(r.b)("h2",{id:"source"},"Source"),Object(r.b)("p",null,"The Stake Pool Program's source is available on\n",Object(r.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/solana-labs/solana-program-library"}),"GitHub"),"."),Object(r.b)("p",null,"For information about the types and instructions, the Stake Pool Rust docs are\navailable at ",Object(r.b)("a",Object(n.a)({parentName:"p"},{href:"https://docs.rs/spl-stake-pool/0.5.0/spl_stake_pool/"}),"docs.rs"),"."),Object(r.b)("h2",{id:"security-audits"},"Security Audits"),Object(r.b)("p",null,"Multiple security firms have audited the stake pool program to ensure total\nsafety of funds. The audit reports are available for reading, presented in descending\nchronological order, and the commit hash that each was reviewed at:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"Quantstamp",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"Initial review commit hash ",Object(r.b)("a",Object(n.a)({parentName:"li"},{href:"https://github.com/solana-labs/solana-program-library/tree/99914c9fc7246b22ef04416586ab1722c89576de"}),Object(r.b)("inlineCode",{parentName:"a"},"99914c9"))),Object(r.b)("li",{parentName:"ul"},"Re-review commit hash ",Object(r.b)("a",Object(n.a)({parentName:"li"},{href:"https://github.com/solana-labs/solana-program-library/tree/3b48fa09d38d1b66ffb4fef186b606f1bc4fdb31"}),Object(r.b)("inlineCode",{parentName:"a"},"3b48fa0"))),Object(r.b)("li",{parentName:"ul"},"Final report ",Object(r.b)("a",Object(n.a)({parentName:"li"},{href:"https://solana.com/SolanaQuantstampStakePoolAudit.pdf"}),"https://solana.com/SolanaQuantstampStakePoolAudit.pdf")))),Object(r.b)("li",{parentName:"ul"},"Neodyme",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"Review commit hash ",Object(r.b)("a",Object(n.a)({parentName:"li"},{href:"https://github.com/solana-labs/solana-program-library/tree/0a85a9a533795b6338ea144e433893c6c0056210"}),Object(r.b)("inlineCode",{parentName:"a"},"0a85a9a"))),Object(r.b)("li",{parentName:"ul"},"Report ",Object(r.b)("a",Object(n.a)({parentName:"li"},{href:"https://solana.com/SolanaNeodymeStakePoolAudit.pdf"}),"https://solana.com/SolanaNeodymeStakePoolAudit.pdf")))),Object(r.b)("li",{parentName:"ul"},"Kudelski",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"Review commit hash ",Object(r.b)("a",Object(n.a)({parentName:"li"},{href:"https://github.com/solana-labs/solana-program-library/tree/3dd67672974f92d3b648bb50ee74f4747a5f8973"}),Object(r.b)("inlineCode",{parentName:"a"},"3dd6767"))),Object(r.b)("li",{parentName:"ul"},"Report ",Object(r.b)("a",Object(n.a)({parentName:"li"},{href:"https://solana.com/SolanaKudelskiStakePoolAudit.pdf"}),"https://solana.com/SolanaKudelskiStakePoolAudit.pdf"))))),Object(r.b)("h2",{id:"command-line-utility"},"Command-line Utility"),Object(r.b)("p",null,"The following explains the instructions available in the Stake Pool Program along\nwith examples using the command-line utility."),Object(r.b)("p",null,"The ",Object(r.b)("inlineCode",{parentName:"p"},"spl-stake-pool")," command-line utility can be used to experiment with SPL\ntokens.  Once you have ",Object(r.b)("a",Object(n.a)({parentName:"p"},{href:"https://rustup.rs/"}),"Rust installed"),", run:"),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ cargo install spl-stake-pool-cli\n")),Object(r.b)("p",null,"Run ",Object(r.b)("inlineCode",{parentName:"p"},"spl-stake-pool --help")," for a full description of available commands."),Object(r.b)("h3",{id:"configuration"},"Configuration"),Object(r.b)("p",null,"The ",Object(r.b)("inlineCode",{parentName:"p"},"spl-stake-pool")," configuration is shared with the ",Object(r.b)("inlineCode",{parentName:"p"},"solana")," command-line tool."),Object(r.b)("h4",{id:"current-configuration"},"Current Configuration"),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"solana config get\nConfig File: ${HOME}/.config/solana/cli/config.yml\nRPC URL: https://api.mainnet-beta.solana.com\nWebSocket URL: wss://api.mainnet-beta.solana.com/ (computed)\nKeypair Path: ${HOME}/.config/solana/id.json\n")),Object(r.b)("h4",{id:"cluster-rpc-url"},"Cluster RPC URL"),Object(r.b)("p",null,"See ",Object(r.b)("a",Object(n.a)({parentName:"p"},{href:"https://docs.solana.com/clusters"}),"Solana clusters")," for cluster-specific RPC URLs"),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"solana config set --url https://api.devnet.solana.com\n")),Object(r.b)("h4",{id:"default-keypair"},"Default Keypair"),Object(r.b)("p",null,"See ",Object(r.b)("a",Object(n.a)({parentName:"p"},{href:"https://docs.solana.com/cli/conventions#keypair-conventions"}),"Keypair conventions"),"\nfor information on how to setup a keypair if you don't already have one."),Object(r.b)("p",null,"Keypair File"),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"solana config set --keypair ${HOME}/new-keypair.json\n")),Object(r.b)("p",null,"Hardware Wallet URL (See ",Object(r.b)("a",Object(n.a)({parentName:"p"},{href:"https://docs.solana.com/wallet-guide/hardware-wallets#specify-a-keypair-url"}),"URL spec"),")"),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"solana config set --keypair usb://ledger/\n")),Object(r.b)("h4",{id:"run-locally"},"Run Locally"),Object(r.b)("p",null,"If you would like to test a stake pool locally without having to wait for stakes\nto activate and deactivate, you can run the stake pool locally using the\n",Object(r.b)("inlineCode",{parentName:"p"},"solana-test-validator")," tool with shorter epochs, and pulling the current program\nfrom devnet."),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ solana-test-validator -c SPoo1Ku8WFXoNDMHPsrGSTSG1Y47rzgn41SLUNakuHy -c EmiU8AQkB2sswTxVB6aCmsAJftoowZGGDXuytm6X65R3 --url devnet --slots-per-epoch 32\n$ solana config set --url http://127.0.0.1:8899\n")),Object(r.b)("h2",{id:"stake-pool-manager-examples"},"Stake Pool Manager Examples"),Object(r.b)("h3",{id:"create-a-stake-pool"},"Create a stake pool"),Object(r.b)("p",null,"The stake pool manager controls the stake pool from a high level, and in exchange\nreceives a fee in the form of SPL tokens. The manager\nsets the fee on creation. Let's create a pool with a 3% fee and a maximum of 1000\nvalidator stake accounts:"),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ spl-stake-pool create-pool --epoch-fee-numerator 3 --epoch-fee-denominator 100 --max-validators 1000\nCreating reserve stake DVwDn4LTRztuai4QeenM6fyzgiwUGpVXVNZ1mgKE1Pyc\nCreating mint BoNneHKDrX9BHjjvSpPfnQyRjsnc9WFH71v8wrgCd7LB\nCreating associated token account DgyZrAq88bnG1TNRxpgDQzWXpzEurCvfY2ukKFWBvADQ to receive stake pool tokens of mint BoNneHKDrX9BHjjvSpPfnQyRjsnc9WFH71v8wrgCd7LB, owned by 4SnSuUtJGKvk2GYpBwmEsWG53zTurVM8yXGsoiZQyMJn\nCreating pool fee collection account DgyZrAq88bnG1TNRxpgDQzWXpzEurCvfY2ukKFWBvADQ\nSignature: qQwqahLuC24wPwVdgVXtd7v5htSSPDAH3JxFNmXCv9aDwjjqygQ64VMg3WdPCiNzc4Bn8vtS3qcnUVHVP5MbKgL\nCreating stake pool Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR\nSignature: 5z6uH3EuPcujeWGpAjBtciSUR3TxtMBgWYU4ULagUso4QGzE9JenhYHwYthJ4b3rS57ByUNEXTr2BFyF5PjWC42Y\n")),Object(r.b)("p",null,"The unique stake pool identifier is ",Object(r.b)("inlineCode",{parentName:"p"},"Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR"),"."),Object(r.b)("p",null,"The identifier for the stake pool's SPL token mint is\n",Object(r.b)("inlineCode",{parentName:"p"},"BoNneHKDrX9BHjjvSpPfnQyRjsnc9WFH71v8wrgCd7LB"),". The stake pool has full control\nover the mint."),Object(r.b)("p",null,"The pool creator's fee account identifier is\n",Object(r.b)("inlineCode",{parentName:"p"},"DgyZrAq88bnG1TNRxpgDQzWXpzEurCvfY2ukKFWBvADQ"),". Every epoch, as stake accounts\nin the stake pool earn rewards, the program will mint SPL pool tokens\nequal to 3% of the gains on that epoch into this account. If no gains were observed,\nnothing will be deposited."),Object(r.b)("p",null,"The reserve stake account identifier is ",Object(r.b)("inlineCode",{parentName:"p"},"J5XB7mWpeaUZxZ6ogXT57qSCobczx27vLZYSgfSbZoBB"),".\nThis account holds onto additional stake used when rebalancing between validators."),Object(r.b)("p",null,"For a stake pool with 1000 validators, the cost to create a stake pool is less\nthan 0.5 SOL."),Object(r.b)("p",null,"The ",Object(r.b)("inlineCode",{parentName:"p"},"create-pool")," command allows setting all of the accounts and keypairs to\npre-generated values, including:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"stake pool, through the ",Object(r.b)("inlineCode",{parentName:"li"},"--pool-keypair")," flag"),Object(r.b)("li",{parentName:"ul"},"validator list, through the ",Object(r.b)("inlineCode",{parentName:"li"},"--validator-list-keypair")," flag"),Object(r.b)("li",{parentName:"ul"},"pool token mint, through the ",Object(r.b)("inlineCode",{parentName:"li"},"--mint-keypair")," flag"),Object(r.b)("li",{parentName:"ul"},"pool reserve stake account, through the ",Object(r.b)("inlineCode",{parentName:"li"},"--reserve-keypair")," flag")),Object(r.b)("p",null,"Otherwise, these will all default to newly-generated keypairs."),Object(r.b)("p",null,"You can always check out the available options by running ",Object(r.b)("inlineCode",{parentName:"p"},"spl-stake-pool create-pool -h"),"."),Object(r.b)("h3",{id:"create-a-restricted-stake-pool"},"Create a restricted stake pool"),Object(r.b)("p",null,"If a manager would like to restrict deposits (stake and SOL) to one key in\nparticular, they can set a deposit authority at creation:"),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ spl-stake-pool create-pool --epoch-fee-numerator 3 --epoch-fee-denominator 100 --max-validators 1000 --deposit-authority authority_keypair.json\nCreating reserve stake DVwDn4LTRztuai4QeenM6fyzgiwUGpVXVNZ1mgKE1Pyc\nCreating mint BoNneHKDrX9BHjjvSpPfnQyRjsnc9WFH71v8wrgCd7LB\nCreating associated token account DgyZrAq88bnG1TNRxpgDQzWXpzEurCvfY2ukKFWBvADQ to receive stake pool tokens of mint BoNneHKDrX9BHjjvSpPfnQyRjsnc9WFH71v8wrgCd7LB, owned by 4SnSuUtJGKvk2GYpBwmEsWG53zTurVM8yXGsoiZQyMJn\nCreating pool fee collection account DgyZrAq88bnG1TNRxpgDQzWXpzEurCvfY2ukKFWBvADQ\nSignature: qQwqahLuC24wPwVdgVXtd7v5htSSPDAH3JxFNmXCv9aDwjjqygQ64VMg3WdPCiNzc4Bn8vtS3qcnUVHVP5MbKgL\nCreating stake pool Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR\nDeposits will be restricted to 4SnSuUtJGKvk2GYpBwmEsWG53zTurVM8yXGsoiZQyMJn only, this can be changed using the set-funding-authority command.\nSignature: 5z6uH3EuPcujeWGpAjBtciSUR3TxtMBgWYU4ULagUso4QGzE9JenhYHwYthJ4b3rS57ByUNEXTr2BFyF5PjWC42Y\n")),Object(r.b)("p",null,"As the output says, the ",Object(r.b)("inlineCode",{parentName:"p"},"set-funding-authority")," can be used to modify or remove\nthe deposit authority."),Object(r.b)("p",null,"As long as the deposit authority is set, SOL and stake deposits must be signed\nby ",Object(r.b)("inlineCode",{parentName:"p"},"4SnSuUtJGKvk2GYpBwmEsWG53zTurVM8yXGsoiZQyMJn"),", so no one else can participate\nin the pool. As mentioned earlier, this feature does not prohibit withdrawals,\nso anyone with pool tokens will still be able to withdraw from the pool."),Object(r.b)("h3",{id:"set-manager"},"Set manager"),Object(r.b)("p",null,"The stake pool manager may pass their administrator privileges to another account."),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ spl-stake-pool set-manager Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR --new-manager 4SnSuUtJGKvk2GYpBwmEsWG53zTurVM8yXGsoiZQyMJn\nSignature: 39N5gkaqXuWm6JPEUWfenKXeG4nSa71p7iHb9zurvdZcsWmbjdmSXwLVYfhAVHWucTY77sJ8SkUNpVpVAhe4eZ53\n")),Object(r.b)("p",null,"At the same time, they may also change the SPL token account that receives fees\nevery epoch. The mint for the provided token account must be the SPL token mint,\n",Object(r.b)("inlineCode",{parentName:"p"},"BoNneHKDrX9BHjjvSpPfnQyRjsnc9WFH71v8wrgCd7LB")," in our example."),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ spl-stake-pool set-manager Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR --new-fee-receiver HoCsh97wRxRXVjtG7dyfsXSwH9VxdDzC7GvAsBE1eqJz\nSignature: 4aK8yzYvPBkP4PyuXTcCm529kjEH6tTt4ixc5D5ZyCrHwc4pvxAHj6wcr4cpAE1e3LddE87J1GLD466aiifcXoAY\n")),Object(r.b)("h3",{id:"set-fee"},"Set fee"),Object(r.b)("p",null,"The stake pool manager may update any of the fees associated with the stake pool,\npassing the numerator and denominator for the fraction that make up the fee."),Object(r.b)("p",null,"For an epoch fee of 10%, they could run:"),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ spl-stake-pool set-fee Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR epoch 10 100\nSignature: 5yPXfVj5cbKBfZiEVi2UR5bXzVDuc2c3ruBwSjkAqpvxPHigwGHiS1mXQVE4qwok5moMWT5RNYAMvkE9bnfQ1i93\n")),Object(r.b)("p",null,"In order to protect stake pool depositors from malicious managers, the program\napplies the new fee for the following epoch."),Object(r.b)("p",null,"For example, if the fee is 1% at epoch 100, and the manager sets it to 10%, the\nmanager will still gain 1% for the rewards earned during epoch 100. Starting\nwith epoch 101, the manager will earn 10%."),Object(r.b)("p",null,"Additionally, to prevent a malicious manager from immediately setting the withdrawal\nfee to a very high amount, making it practically impossible for users to withdraw,\nthe stake pool program currently enforces a limit of 1.5x increase per epoch."),Object(r.b)("p",null,"For example, if the current withdrawal fee is 2.5%, the maximum that can be set\nfor the next epoch is 3.75%."),Object(r.b)("p",null,"The possible options for the fee type are ",Object(r.b)("inlineCode",{parentName:"p"},"epoch"),", ",Object(r.b)("inlineCode",{parentName:"p"},"sol-withdrawal"),",\n",Object(r.b)("inlineCode",{parentName:"p"},"stake-withdrawal"),", ",Object(r.b)("inlineCode",{parentName:"p"},"sol-deposit"),", and ",Object(r.b)("inlineCode",{parentName:"p"},"stake-deposit"),"."),Object(r.b)("h3",{id:"set-referral-fee"},"Set referral fee"),Object(r.b)("p",null,"The stake pool manager may update the referral fee on deposits at any time, passing\nin a percentage amount."),Object(r.b)("p",null,"To set a stake deposit referral fee of 80%, they may run:"),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ spl-stake-pool set-referral-fee Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR stake 80\nSignature: 4vhaBEDhuKkVwMxy7TpyfHEk3Z5kGZKerD1AgajQBdiMRQLZuNZKVR3KQaqbUYZM7UyfRXgkZNdAeP1NfvmwKdqb\n")),Object(r.b)("p",null,"For 80%, this means that 20% of the stake deposit fee goes to the manager, and\n80% goes to the referrer."),Object(r.b)("h3",{id:"set-staker"},"Set staker"),Object(r.b)("p",null,"In order to manage the stake accounts, the stake pool manager or\nstaker can set the staker authority of the stake pool's managed accounts."),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ spl-stake-pool set-staker Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR 4SnSuUtJGKvk2GYpBwmEsWG53zTurVM8yXGsoiZQyMJn\nSignature: 39N5gkaqXuWm6JPEUWfenKXeG4nSa71p7iHb9zurvdZcsWmbjdmSXwLVYfhAVHWucTY77sJ8SkUNpVpVAhe4eZ53\n")),Object(r.b)("p",null,"Now, the new staker can perform any normal stake pool operations, including\nadding and removing validators and rebalancing stake."),Object(r.b)("p",null,"Important security note: the stake pool program only gives staking authority to\nthe pool staker and always retains withdraw authority. Therefore, a malicious\nstake pool staker cannot steal funds from the stake pool."),Object(r.b)("p",null,'Note: to avoid "disturbing the manager", the staker can also reassign their stake\nauthority.'),Object(r.b)("h3",{id:"set-funding-authority"},"Set Funding Authority"),Object(r.b)("p",null,"To restrict who can interact with the pool, the stake pool manager may require\na particular signature on stake deposits, SOL deposits, or SOL withdrawals. This\ndoes not make the pool private, since all information is available on-chain, but\nit restricts who can use the pool."),Object(r.b)("p",null,"As an example, let's say a pool wants to restrict all SOL withdrawals."),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ spl-stake-pool set-funding-authority Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR sol-withdraw AZ1PgxWSxw4ezX8gvpNgGsr39jJHCwtkaXr1mNMwWWeK\nSignature: 3gx7ckGNSL7gUUyxh4CU3RH3Lyt88hiCvYQ4QRKtnmrZHvAS93ebP6bf39WYGTeKDMVSJUuwBEmk9VFSaWtXsHVV\n")),Object(r.b)("p",null,"After running this command, ",Object(r.b)("inlineCode",{parentName:"p"},"AZ1PgxWSxw4ezX8gvpNgGsr39jJHCwtkaXr1mNMwWWeK")," must\nsign all SOL withdrawals, otherwise the operation fails."),Object(r.b)("p",null,"After some time, if the manager wishes to enable SOL withdrawals, they can remove\nthe restriction:"),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ spl-stake-pool set-funding-authority Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR sol-withdraw --unset\nSignature: 5kWeBqoxyvANMHCP4ydsZRf8QU4hMotLnKkFbTEdvqEVywo4F3MpZtay7D57FbjJZpdp72fc3vrbxJi9qDLfLCnD\n")),Object(r.b)("p",null,"Now, anyone can withdraw SOL from the stake pool, provided there is enough SOL left\nin the reserve."),Object(r.b)("p",null,"The options for funding authorities are ",Object(r.b)("inlineCode",{parentName:"p"},"sol-withdraw"),", ",Object(r.b)("inlineCode",{parentName:"p"},"sol-deposit"),", and ",Object(r.b)("inlineCode",{parentName:"p"},"stake-deposit"),"."),Object(r.b)("p",null,"Note: it is impossible to restrict stake withdrawals. This would create an opportunity\nfor malicious pool managers to effectively lock user funds."),Object(r.b)("h2",{id:"stake-pool-staker-examples"},"Stake Pool Staker Examples"),Object(r.b)("h3",{id:"add-a-validator-to-the-pool"},"Add a validator to the pool"),Object(r.b)("p",null,"In order to accommodate large numbers of user deposits into the stake pool, the\nstake pool only manages one stake account per validator. To add a new validator\nto the stake pool, the staker must use the ",Object(r.b)("inlineCode",{parentName:"p"},"add-validator")," command."),Object(r.b)("p",null,"Let's add some random validators to the stake pool."),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ spl-stake-pool add-validator Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR 38DYMkwYCvsj8TC6cNaEvFHHVDYeWDp1qUgMgyjNqZXk\nAdding stake account F8e8Ympp4MkDSPZdvRxdQUZXRkMBDdyqgHa363GShAPt, delegated to 38DYMkwYCvsj8TC6cNaEvFHHVDYeWDp1qUgMgyjNqZXk\nSignature: 5tdpsx64mVcSHBK8vMbBzFDHnEZB6GUmVpqSXXE5hezMAzPYwZbJCBtAHakDAiuWNcrMongGrmwDaeywhVz4i8pi\n")),Object(r.b)("p",null,"In order to maximize censorship resistance, we want to distribute our SOL to as\nmany validators as possible, so let's add a few more."),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ spl-stake-pool add-validator Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR J3xu64PWShcMen99kU3igxtwbke2Nwfo8pkZNRgrq66H\nAdding stake account 5AaobwjccyHnXhFCd24uiX6VqPjXE3Ry4o92fJjqqjAr, delegated to J3xu64PWShcMen99kU3igxtwbke2Nwfo8pkZNRgrq66H\nSignature: 4xeve6gWuiffqBLAMcqa8s7dCMvBmSVdKbDu5WQhigLiXHdCjSNEwoZRexTZji786qgEjXg3nrUh4HcTt3RauZV5\n$ spl-stake-pool add-validator Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR EhRbKi4Vhm1oUCGWHiLEMYZqDrHwEd7Jgzgi26QJKvfQ\nAdding stake account 3k7Nwu9jUSc6SNG11wzufKYoZXRFgxWamheGLYWp5Rvx, delegated to EhRbKi4Vhm1oUCGWHiLEMYZqDrHwEd7Jgzgi26QJKvfQ\nSignature: 4VJYHpPmWkP99TdgYUTgLYixmhqmqsEkWtg4j7zvGZFjYbnLgryu48aV6ub8bqDyULzKckUhb6tvcmZmMX5AFf5G\n")),Object(r.b)("p",null,"We can see the status of a stake account using the Solana command-line utility."),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ solana stake-account 5AaobwjccyHnXhFCd24uiX6VqPjXE3Ry4o92fJjqqjAr\nBalance: 0.00328288 SOL\nRent Exempt Reserve: 0.00228288 SOL\nDelegated Stake: 0.001 SOL\nActive Stake: 0 SOL\nActivating Stake: 0.001 SOL\nStake activates starting from epoch: 5\nDelegated Vote Account Address: J3xu64PWShcMen99kU3igxtwbke2Nwfo8pkZNRgrq66H\nStake Authority: DS3AyFN9dF1ruNBcSeo8XXQR8UyVMhcCPcnjU5GnY18S\nWithdraw Authority: DS3AyFN9dF1ruNBcSeo8XXQR8UyVMhcCPcnjU5GnY18S\n")),Object(r.b)("p",null,"The stake pool creates these special staking accounts with 0.001 SOL as the required\nminimum delegation amount. The stake and withdraw authorities are the stake pool\nwithdraw authority, program addresses derived from the stake pool's address."),Object(r.b)("p",null,"We can also see the status of the stake pool."),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ spl-stake-pool list Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR\nStake Pool: Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR\nPool Token Mint: BoNneHKDrX9BHjjvSpPfnQyRjsnc9WFH71v8wrgCd7LB\nEpoch Fee: 3/100 of epoch rewards\nWithdrawal Fee: none\nStake Deposit Fee: none\nSOL Deposit Fee: none\nSOL Deposit Referral Fee: none\nStake Deposit Referral Fee: none\nReserve Account: EN4px2h4gFkYtsQUi4yeCYBrdRM4DoRxCVJyavMXEAm5   Available Balance: \u25ce0.000000000\nVote Account: EhRbKi4Vhm1oUCGWHiLEMYZqDrHwEd7Jgzgi26QJKvfQ      Balance: \u25ce0.000000000 Last Update Epoch: 4\nVote Account: J3xu64PWShcMen99kU3igxtwbke2Nwfo8pkZNRgrq66H      Balance: \u25ce0.000000000  Last Update Epoch: 4\nVote Account: 38DYMkwYCvsj8TC6cNaEvFHHVDYeWDp1qUgMgyjNqZXk      Balance: \u25ce0.000000000  Last Update Epoch: 4\nTotal Pool Stake: \u25ce0.000000000\nTotal Pool Tokens: 0.00000000\nCurrent Number of Validators: 3\nMax Number of Validators: 1000\n")),Object(r.b)("p",null,"To make reading easier, the tool will not show balances that cannot be touched by\nthe stake pool. The stake account ",Object(r.b)("inlineCode",{parentName:"p"},"5AaobwjccyHnXhFCd24uiX6VqPjXE3Ry4o92fJjqqjAr"),",\ndelegated to ",Object(r.b)("inlineCode",{parentName:"p"},"J3xu64PWShcMen99kU3igxtwbke2Nwfo8pkZNRgrq66H"),", actually has a balance\nof 0.00328288 SOL, but since this is the minimum required amount, it is\nnot shown by the CLI."),Object(r.b)("h3",{id:"remove-validator-stake-account"},"Remove validator stake account"),Object(r.b)("p",null,"If the stake pool staker wants to stop delegating to a vote account, they can\ntotally remove the validator stake account from the stake pool."),Object(r.b)("p",null,"As with adding a validator, the validator stake account must have exactly\n0.00328288 SOL (0.001 SOL delegated, 0.00228288 SOL for rent exemption) to be removed."),Object(r.b)("p",null,"If that is not the case, the staker must first decrease the stake to that minimum amount.\nLet's assume that the validator stake account delegated to\n",Object(r.b)("inlineCode",{parentName:"p"},"J3xu64PWShcMen99kU3igxtwbke2Nwfo8pkZNRgrq66H")," has a total delegated amount of\n7.5 SOL. To reduce that number, the staker can run:"),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ spl-stake-pool decrease-validator-stake Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR J3xu64PWShcMen99kU3igxtwbke2Nwfo8pkZNRgrq66H 6.5\nSignature: ZpQGwT85rJ8Y9afdkXhKo3TVv4xgTz741mmZj2vW7mihYseAkFsazWxza2y8eNGY4HDJm15c1cStwyiQzaM3RpH\n")),Object(r.b)("p",null,"Now, let's try to remove validator ",Object(r.b)("inlineCode",{parentName:"p"},"J3xu64PWShcMen99kU3igxtwbke2Nwfo8pkZNRgrq66H"),", with\nstake account ",Object(r.b)("inlineCode",{parentName:"p"},"5AaobwjccyHnXhFCd24uiX6VqPjXE3Ry4o92fJjqqjAr"),"."),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ spl-stake-pool remove-validator Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR J3xu64PWShcMen99kU3igxtwbke2Nwfo8pkZNRgrq66H\nRemoving stake account 5AaobwjccyHnXhFCd24uiX6VqPjXE3Ry4o92fJjqqjAr, delegated to J3xu64PWShcMen99kU3igxtwbke2Nwfo8pkZNRgrq66H\nCreating account to receive stake nHEEyey8KkgHuVRAUDzkH5Q4PkA4veSHuTxgG6C8L2G\nSignature: 4XprnR768Ch6LUvqUVLTjMCiqdYvtjNfECh4izErqwbsASTGjUBz7NtLZHAiraTqhs7b9PoSAazetdsgXa6J4wVu\n")),Object(r.b)("p",null,"Unlike a normal withdrawal, the validator stake account is totally moved from\nthe stake pool and into a new account belonging to the administrator."),Object(r.b)("p",null,"Note: since removal is only possible when the validator stake is at the minimum\namount of 0.00328288, the administrator does not get any control of user funds,\nand only recovers the amount contributed during ",Object(r.b)("inlineCode",{parentName:"p"},"add-validator"),"."),Object(r.b)("p",null,"The authority for the withdrawn stake account can also be specified using the\n",Object(r.b)("inlineCode",{parentName:"p"},"--new-authority")," flag:"),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ spl-stake-pool remove-validator Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR J3xu64PWShcMen99kU3igxtwbke2Nwfo8pkZNRgrq66H --new-authority 4SnSuUtJGKvk2GYpBwmEsWG53zTurVM8yXGsoiZQyMJn\nSignature: 5rrQ3xhDWyiPkUTAQkNAeq31n6sMf1xsg2x9hVY8Vj1NonwBnhxuTv87nADLkwC8Xzc4CGTNCTX2Vph9esWnXk2d\n")),Object(r.b)("p",null,"We can check the removed stake account:"),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ solana stake-account nHEEyey8KkgHuVRAUDzkH5Q4PkA4veSHuTxgG6C8L2G\nBalance: 0.003282880 SOL\nRent Exempt Reserve: 0.00328288 SOL\nDelegated Stake: 0.001000000 SOL\nActive Stake: 0.001000000 SOL\nDelegated Vote Account Address: J3xu64PWShcMen99kU3igxtwbke2Nwfo8pkZNRgrq66H\nStake Authority: 4SnSuUtJGKvk2GYpBwmEsWG53zTurVM8yXGsoiZQyMJn\nWithdraw Authority: 4SnSuUtJGKvk2GYpBwmEsWG53zTurVM8yXGsoiZQyMJn\n")),Object(r.b)("h3",{id:"rebalance-the-stake-pool"},"Rebalance the stake pool"),Object(r.b)("p",null,"As time goes on, users will deposit to and withdraw from all of the stake accounts\nmanaged by the pool, and the stake pool staker may want to rebalance the stakes."),Object(r.b)("p",null,"For example, let's say the staker wants the same delegation to every validator\nin the pool. When they look at the state of the pool, they see:"),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ spl-stake-pool list Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR\nStake Pool: Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR\nPool Token Mint: BoNneHKDrX9BHjjvSpPfnQyRjsnc9WFH71v8wrgCd7LB\nEpoch Fee: 3/100 of epoch rewards\nWithdrawal Fee: none\nStake Deposit Fee: none\nSOL Deposit Fee: none\nSOL Deposit Referral Fee: none\nStake Deposit Referral Fee: none\nReserve Account: EN4px2h4gFkYtsQUi4yeCYBrdRM4DoRxCVJyavMXEAm5   Available Balance: \u25ce10.006848640\nVote Account: EhRbKi4Vhm1oUCGWHiLEMYZqDrHwEd7Jgzgi26QJKvfQ      Balance: \u25ce100.000000000 Last Update Epoch: 4\nVote Account: J3xu64PWShcMen99kU3igxtwbke2Nwfo8pkZNRgrq66H      Balance: \u25ce10.000000000  Last Update Epoch: 4\nVote Account: 38DYMkwYCvsj8TC6cNaEvFHHVDYeWDp1qUgMgyjNqZXk      Balance: \u25ce10.000000000  Last Update Epoch: 4\nTotal Pool Stake: \u25ce130.006848640\nTotal Pool Tokens: 130.00684864\nCurrent Number of Validators: 3\nMax Number of Validators: 1000\n")),Object(r.b)("p",null,"This isn't great! The first stake account, ",Object(r.b)("inlineCode",{parentName:"p"},"EhRbKi4Vhm1oUCGWHiLEMYZqDrHwEd7Jgzgi26QJKvfQ"),"\nhas too much allocated. For their strategy, the staker wants the ",Object(r.b)("inlineCode",{parentName:"p"},"100"),"\nSOL to be distributed evenly, meaning ",Object(r.b)("inlineCode",{parentName:"p"},"40")," in each account. They need\nto move ",Object(r.b)("inlineCode",{parentName:"p"},"30")," to ",Object(r.b)("inlineCode",{parentName:"p"},"J3xu64PWShcMen99kU3igxtwbke2Nwfo8pkZNRgrq66H")," and\n",Object(r.b)("inlineCode",{parentName:"p"},"38DYMkwYCvsj8TC6cNaEvFHHVDYeWDp1qUgMgyjNqZXk"),"."),Object(r.b)("h4",{id:"decrease-validator-stake"},"Decrease validator stake"),Object(r.b)("p",null,"First, they need to decrease the amount on stake account\n",Object(r.b)("inlineCode",{parentName:"p"},"3k7Nwu9jUSc6SNG11wzufKYoZXRFgxWamheGLYWp5Rvx"),", delegated to\n",Object(r.b)("inlineCode",{parentName:"p"},"EhRbKi4Vhm1oUCGWHiLEMYZqDrHwEd7Jgzgi26QJKvfQ"),", by a total of ",Object(r.b)("inlineCode",{parentName:"p"},"60")," SOL."),Object(r.b)("p",null,"They decrease that amount of SOL:"),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-sh"}),"$ spl-stake-pool decrease-validator-stake Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR EhRbKi4Vhm1oUCGWHiLEMYZqDrHwEd7Jgzgi26QJKvfQ 60\nSignature: ZpQGwT85rJ8Y9afdkXhKo3TVv4xgTz741mmZj2vW7mihYseAkFsazWxza2y8eNGY4HDJm15c1cStwyiQzaM3RpH\n")),Object(r.b)("p",null,"Internally, this instruction splits and deactivates 60 SOL from the\nvalidator stake account ",Object(r.b)("inlineCode",{parentName:"p"},"3k7Nwu9jUSc6SNG11wzufKYoZXRFgxWamheGLYWp5Rvx")," into a\ntransient stake account, owned and managed entirely by the stake pool."),Object(r.b)("p",null,"Once the stake is deactivated during the next epoch, the ",Object(r.b)("inlineCode",{parentName:"p"},"update")," command will\nautomatically merge the transient stake account into a reserve stake account,\nalso entirely owned and managed by the stake pool."),Object(r.b)("h4",{id:"increase-validator-stake"},"Increase validator stake"),Object(r.b)("p",null,"Now that the reserve stake account has enough to perform the rebalance, the staker\ncan increase the stake on the two other validators,\n",Object(r.b)("inlineCode",{parentName:"p"},"J3xu64PWShcMen99kU3igxtwbke2Nwfo8pkZNRgrq66H")," and\n",Object(r.b)("inlineCode",{parentName:"p"},"38DYMkwYCvsj8TC6cNaEvFHHVDYeWDp1qUgMgyjNqZXk"),"."),Object(r.b)("p",null,"They add 30 SOL to ",Object(r.b)("inlineCode",{parentName:"p"},"J3xu64PWShcMen99kU3igxtwbke2Nwfo8pkZNRgrq66H"),":"),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-sh"}),"$ spl-stake-pool increase-validator-stake Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR J3xu64PWShcMen99kU3igxtwbke2Nwfo8pkZNRgrq66H 30\nSignature: 3GJACzjUGLPjcd9RLUW86AfBLWKapZRkxnEMc2yHT6erYtcKBgCapzyrVH6VN8Utxj7e2mtvzcigwLm6ZafXyTMw\n")),Object(r.b)("p",null,"And they add 30 SOL to ",Object(r.b)("inlineCode",{parentName:"p"},"38DYMkwYCvsj8TC6cNaEvFHHVDYeWDp1qUgMgyjNqZXk"),":"),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-sh"}),"$ spl-stake-pool increase-validator-stake Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR 38DYMkwYCvsj8TC6cNaEvFHHVDYeWDp1qUgMgyjNqZXk 30\nSignature: 4zaKYu3MQ3as8reLbuHKaXN8FNaHvpHuiZtsJeARo67UKMo6wUUoWE88Fy8N4EYQYicuwULTNffcUD3a9jY88PoU\n")),Object(r.b)("p",null,"Internally, this instruction also uses transient stake accounts.  This time, the\nstake pool splits from the reserve stake, into the transient stake account,\nthen activates it to the appropriate validator."),Object(r.b)("p",null,"One to two epochs later, once the transient stakes activate, the ",Object(r.b)("inlineCode",{parentName:"p"},"update")," command\nautomatically merges the transient stakes into the validator stake account, leaving\na fully rebalanced stake pool:"),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ spl-stake-pool list Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR\nStake Pool: Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR\nPool Token Mint: BoNneHKDrX9BHjjvSpPfnQyRjsnc9WFH71v8wrgCd7LB\nPreferred Deposit Validator: 38DYMkwYCvsj8TC6cNaEvFHHVDYeWDp1qUgMgyjNqZXk\nEpoch Fee: 3/100 of epoch rewards\nWithdrawal Fee: none\nStake Deposit Fee: none\nSOL Deposit Fee: none\nSOL Deposit Referral Fee: none\nStake Deposit Referral Fee: none\nReserve Account: EN4px2h4gFkYtsQUi4yeCYBrdRM4DoRxCVJyavMXEAm5   Available Balance: \u25ce10.006848640\nVote Account: EhRbKi4Vhm1oUCGWHiLEMYZqDrHwEd7Jgzgi26QJKvfQ      Balance: \u25ce40.000000000  Last Update Epoch: 8\nVote Account: J3xu64PWShcMen99kU3igxtwbke2Nwfo8pkZNRgrq66H      Balance: \u25ce40.000000000  Last Update Epoch: 8\nVote Account: 38DYMkwYCvsj8TC6cNaEvFHHVDYeWDp1qUgMgyjNqZXk      Balance: \u25ce40.000000000  Last Update Epoch: 8\nTotal Pool Stake: \u25ce130.006848640\nTotal Pool Tokens: 130.00684864\nCurrent Number of Validators: 3\nMax Number of Validators: 1000\n")),Object(r.b)("p",null,"Due to staking rewards that accrued during the rebalancing process, the pool may\nnot perfectly balanced. This is completely normal."),Object(r.b)("h3",{id:"set-preferred-deposit--withdraw-validator"},"Set Preferred Deposit / Withdraw Validator"),Object(r.b)("p",null,"Since a stake pool accepts deposits to any of its stake accounts, and allows\nwithdrawals from any of its stake accounts, it could be used by malicious arbitrageurs\nlooking to maximize returns each epoch."),Object(r.b)("p",null,"For example, if a stake pool has 1000 validators, an arbitrageur could stake to\nany one of those validators. At the end of the epoch, they can check which\nvalidator has the best performance, deposit their stake, and immediately withdraw\nfrom the highest performing validator. Once rewards are paid out, they can take\ntheir valuable stake, and deposit it back for more than they had."),Object(r.b)("p",null,"To mitigate this arbitrage, a stake pool staker can set a preferred withdraw\nor deposit validator. Any deposits or withdrawals must go to the corresponding\nstake account, making this attack impossible without a lot of funds."),Object(r.b)("p",null,"Let's set a preferred deposit validator stake account:"),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ spl-stake-pool set-preferred-validator Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR deposit --vote-account EhRbKi4Vhm1oUCGWHiLEMYZqDrHwEd7Jgzgi26QJKvfQ\nSignature: j6fbTqGJ8ehgKnSPns1adaSeFwg5M3wP1a32qYwZsQjymYoSejFUXLNGwvHSouJcFm4C78HUoC8xd7cvb5iActL\n")),Object(r.b)("p",null,"And then let's set the preferred withdraw validator stake account to the same one:"),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ spl-stake-pool set-preferred-validator Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR withdraw --vote-account EhRbKi4Vhm1oUCGWHiLEMYZqDrHwEd7Jgzgi26QJKvfQ\nSignature: 4MKdYLyFqU6H3311YZDeLtsoeGZMzswBHyBCRjHfkzuN1rB4LXJbPfkgUGLKkdbsxJvPRub7SqB1zNPTqDdwti2w\n")),Object(r.b)("p",null,"At any time, they may also unset the preferred validator:"),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ spl-stake-pool set-preferred-validator Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR withdraw --unset\nSignature: 5Qh9FA3EXtJ7nKw7UyxmMWXnTMLRKQqcpvfEsEyBtxSPqzPAXp2vFXnPg1Pw8f37JFdvyzYay65CtA8Z1ewzVkvF\n")),Object(r.b)("p",null,"The preferred validators are marked in the ",Object(r.b)("inlineCode",{parentName:"p"},"list")," command:"),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ spl-stake-pool list Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR\nStake Pool: Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR\nPool Token Mint: BoNneHKDrX9BHjjvSpPfnQyRjsnc9WFH71v8wrgCd7LB\nPreferred Deposit Validator: EhRbKi4Vhm1oUCGWHiLEMYZqDrHwEd7Jgzgi26QJKvfQ\nPreferred Withdraw Validator: EhRbKi4Vhm1oUCGWHiLEMYZqDrHwEd7Jgzgi26QJKvfQ\n...\n")),Object(r.b)("h2",{id:"user-examples"},"User Examples"),Object(r.b)("h3",{id:"list-validator-stake-accounts"},"List validator stake accounts"),Object(r.b)("p",null,"In order to deposit into the stake pool, a user must first delegate some stake\nto one of the validator stake accounts associated with the stake pool. The\ncommand-line utility has a special instruction for finding out which vote\naccounts are already associated with the stake pool."),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ spl-stake-pool list Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR\nStake Pool: Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR\nPool Token Mint: BoNneHKDrX9BHjjvSpPfnQyRjsnc9WFH71v8wrgCd7LB\nPreferred Deposit Validator: 38DYMkwYCvsj8TC6cNaEvFHHVDYeWDp1qUgMgyjNqZXk\nEpoch Fee: 3/100 of epoch rewards\nWithdrawal Fee: none\nStake Deposit Fee: none\nSOL Deposit Fee: none\nSOL Deposit Referral Fee: none\nStake Deposit Referral Fee: none\nReserve Account: EN4px2h4gFkYtsQUi4yeCYBrdRM4DoRxCVJyavMXEAm5   Available Balance: \u25ce10.006848640\nVote Account: EhRbKi4Vhm1oUCGWHiLEMYZqDrHwEd7Jgzgi26QJKvfQ      Balance: \u25ce35.000000000  Last Update Epoch: 8\nVote Account: J3xu64PWShcMen99kU3igxtwbke2Nwfo8pkZNRgrq66H      Balance: \u25ce35.000000000  Last Update Epoch: 8\nVote Account: 38DYMkwYCvsj8TC6cNaEvFHHVDYeWDp1qUgMgyjNqZXk      Balance: \u25ce35.000000000  Last Update Epoch: 8\nTotal Pool Stake: \u25ce115.006848640\nTotal Pool Tokens: 115.00684864\nCurrent Number of Validators: 3\nMax Number of Validators: 1000\n")),Object(r.b)("h3",{id:"deposit-sol"},"Deposit SOL"),Object(r.b)("p",null,"Stake pools accept SOL deposits directly from a normal SOL wallet account, and\nin exchange mint the appropriate amount of pool tokens."),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ spl-stake-pool deposit-sol Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR 100\nUsing existing associated token account DgyZrAq88bnG1TNRxpgDQzWXpzEurCvfY2ukKFWBvADQ to receive stake pool tokens of mint BoNneHKDrX9BHjjvSpPfnQyRjsnc9WFH71v8wrgCd7LB, owned by 4SnSuUtJGKvk2GYpBwmEsWG53zTurVM8yXGsoiZQyMJn\nSignature: 23CptpZaq33njCpJPAvk8XS53xXwpfqF1sGxChk3VDB5mzz7XPKQqwsreun3iwZ6b51AyHqGBaUyc6tx9fqvF9JK\n")),Object(r.b)("p",null,"In return, the stake pool has minted us new pool tokens, representing our share\nof ownership in the pool.  We can double-check our stake pool account using the\nSPL token command-line utility."),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ spl-token balance BoNneHKDrX9BHjjvSpPfnQyRjsnc9WFH71v8wrgCd7LB\n100.00000000\n")),Object(r.b)("h3",{id:"withdraw-sol"},"Withdraw SOL"),Object(r.b)("p",null,"Stake pools allow SOL withdrawals directly from the reserve and into a normal\nSOL wallet account, and in exchange burns the provided pool tokens."),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ spl-stake-pool withdraw-sol Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR 7VXPpSxneL6JLj18Naw2gkukXtjBZfbmPh18cnoUCMD8 2\nSignature: 4bqZKUUrjVspqTGqGqX4zxnHnJB67WbeukKUZRmxJ2yFmr275CtHPjZNzQJD9Pe7Q6mSxnUpcVv9FUdAbGP9RyBc\n")),Object(r.b)("p",null,"The stake pool has burned 2 pool tokens, and in return, sent SOL to\n",Object(r.b)("inlineCode",{parentName:"p"},"7VXPpSxneL6JLj18Naw2gkukXtjBZfbmPh18cnoUCMD8"),"."),Object(r.b)("p",null,"You can check that the pool tokens have been burned:"),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ spl-token balance BoNneHKDrX9BHjjvSpPfnQyRjsnc9WFH71v8wrgCd7LB\n98.00000000\n")),Object(r.b)("p",null,"And you can check that the recipient has been credited:"),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ solana balance 7VXPpSxneL6JLj18Naw2gkukXtjBZfbmPh18cnoUCMD8\n2 SOL\n")),Object(r.b)("h3",{id:"deposit-stake"},"Deposit stake"),Object(r.b)("p",null,"Stake pools also accept deposits from active stake accounts, so we must first\ncreate stake accounts and delegate them to one of the validators managed by the\nstake pool. Using the ",Object(r.b)("inlineCode",{parentName:"p"},"list")," command from the previous section, we see that\n",Object(r.b)("inlineCode",{parentName:"p"},"38DYMkwYCvsj8TC6cNaEvFHHVDYeWDp1qUgMgyjNqZXk")," is a valid vote account, so let's\ncreate a stake account and delegate our stake there."),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ solana-keygen new --no-passphrase -o stake-account.json\nGenerating a new keypair\nWrote new keypair to stake-account.json\n============================================================================\npubkey: 97wBBiLVA7fUViEew8yV8R6tTdKithZDVz8LHLfF9sTJ\n============================================================================\nSave this seed phrase to recover your new keypair:\n++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n============================================================================\n$ solana create-stake-account stake-account.json 10\nSignature: 5Y9r6MNoqJzVX8TWryAJbdp8i2DvintfxbYWoY6VcLEPgphK2tdydhtJTd3o3dF7QdM2Pg8sBFDZuyNcMag3nPvj\n$ solana delegate-stake 97wBBiLVA7fUViEew8yV8R6tTdKithZDVz8LHLfF9sTJ 38DYMkwYCvsj8TC6cNaEvFHHVDYeWDp1qUgMgyjNqZXk\nSignature: 2cDjHXSHjuadGQf1NQpPi43A8R19aCifsY16yTcictKPHcSAXN5TvXZ58nDJwkYs12tuZfTh5WVgAMSvptfrKdPP\n")),Object(r.b)("p",null,"Two epochs later, when the stake is fully active and has received one epoch of\nrewards, we can deposit the stake into the stake pool."),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ spl-stake-pool deposit-stake Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR 97wBBiLVA7fUViEew8yV8R6tTdKithZDVz8LHLfF9sTJ\nDepositing stake 97wBBiLVA7fUViEew8yV8R6tTdKithZDVz8LHLfF9sTJ into stake pool account F8e8Ympp4MkDSPZdvRxdQUZXRkMBDdyqgHa363GShAPt\nUsing existing associated token account DgyZrAq88bnG1TNRxpgDQzWXpzEurCvfY2ukKFWBvADQ to receive stake pool tokens of mint BoNneHKDrX9BHjjvSpPfnQyRjsnc9WFH71v8wrgCd7LB, owned by 4SnSuUtJGKvk2GYpBwmEsWG53zTurVM8yXGsoiZQyMJn\nSignature: 45x2UtA1b49eBPtRHdkvA3k8JneZzfwjptNN1kKQZaPABYiJ4hSA8qwi7qLNN5b3Fr4Z6vXhJprrTCpkk3f8UqgD\n")),Object(r.b)("p",null,"The CLI will default to using the fee payer's\n",Object(r.b)("a",Object(n.a)({parentName:"p"},{href:"/solana-program-library/spl/associated-token-account"}),"Associated Token Account")," for stake pool tokens\nand the withdraw authority on the deposited stake account."),Object(r.b)("p",null,"Alternatively, you can create an SPL token account yourself and pass it as the\n",Object(r.b)("inlineCode",{parentName:"p"},"token-receiver")," for the command, and specify the withdraw authority on the\nstake account using the ",Object(r.b)("inlineCode",{parentName:"p"},"withdraw-authority")," flag."),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ spl-stake-pool deposit-stake Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR 97wBBiLVA7fUViEew8yV8R6tTdKithZDVz8LHLfF9sTJ --token-receiver 34XMHa3JUPv46ftU4dGHvemZ9oKVjnciRePYMcX3rjEF --withdraw-authority authority.json\nDepositing stake 97wBBiLVA7fUViEew8yV8R6tTdKithZDVz8LHLfF9sTJ into stake pool account F8e8Ympp4MkDSPZdvRxdQUZXRkMBDdyqgHa363GShAPt\nSignature: 4AESGZzqBVfj5xQnMiPWAwzJnAtQDRFK1Ha6jqKKTs46Zm5fw3LqgU1mRAT6CKTywVfFMHZCLm1hcQNScSMwVvjQ\n")),Object(r.b)("p",null,"In return, the stake pool has minted us new pool tokens, representing our share\nof ownership in the pool.  We can double-check our stake pool account using the\nSPL token command-line utility."),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ spl-token balance BoNneHKDrX9BHjjvSpPfnQyRjsnc9WFH71v8wrgCd7LB\n10.00000000\n")),Object(r.b)("h4",{id:"note-on-stake-deposit-fee"},"Note on stake deposit fee"),Object(r.b)("p",null,"Stake pools have separate fees for stake and SOL, so the total fee from depositing\na stake account is calculated from the rent-exempt reserve as SOL, and the delegation\nas stake."),Object(r.b)("p",null,"For example, if a stake pool has a stake deposit fee of 1%, and a SOL deposit fee\nof 5%, and you deposit a stake account with 10 SOL in stake, and .00228288 SOL\nin rent-exemption, the total fee charged is:"),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{}),"total_fee = stake_delegation * stake_deposit_fee + rent_exemption * sol_deposit_fee\ntotal_fee = 10 * 1% + .00228288 * 5%\ntotal_fee = 0.100114144\n")),Object(r.b)("h3",{id:"update"},"Update"),Object(r.b)("p",null,"Every epoch, the network pays out rewards to stake accounts managed by the stake\npool, increasing the value of pool tokens minted on deposit.\nIn order to calculate the proper value of these stake pool tokens, we must update\nthe total value managed by the stake pool every epoch."),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ spl-stake-pool update Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR\nSignature: 2rtPNGKFSSnXFCb6MKG5wHp34dkB5hJWNhro8EU2oGh1USafAgzu98EgoRnPLi7ojQfmTpvXk4S7DWXYGu5t85Ka\nSignature: 5V2oCNvZCNJfC6QXHmR2UHGxVMip6nfZixYkVjFQBTyTf2Z9s9GJ9BjkxSFGvUsvW6zc2cCRv9Lqucu1cgHMFcVU\n")),Object(r.b)("p",null,"If another user already updated the stake pool balance for the current epoch, we\nsee a different output."),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-sh"}),"$ spl-stake-pool update Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR\nUpdate not required\n")),Object(r.b)("p",null,"If no one updates the stake pool in the current epoch, all instructions, including\ndeposit and withdraw, will fail. The update instruction is permissionless, so any user\ncan run it before interacting with the pool. As a convenience, the CLI attempts\nto update before running any instruction on the stake pool."),Object(r.b)("p",null,"If the stake pool transient stakes are in an unexpected state, and merges are\nnot possible, there is the option to only update the stake pool balances without\nperforming merges using the ",Object(r.b)("inlineCode",{parentName:"p"},"--no-merge")," flag."),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-sh"}),"$ spl-stake-pool update Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR --no-merge\nSignature: 5cjdZG727uzwnEEG3vJ1vskA9WsXibaEHh7imXSb2S1cwEYK4Q3btr2GEeAV8EffK4CEQ2WM6PQxawkJAHoZ4jsQ\nSignature: EBHbSRstJ3HxKwYKak8vEwVMKr1UBxdbqs5KuX3XYt4ppPjhaziGEtvL2TJCm1HLokbrtMeTEv57Ef4xhByJtJP\n")),Object(r.b)("p",null,"Later on, whenever the transient stakes are ready to be merged, it is possible to\nforce another update in the same epoch using the ",Object(r.b)("inlineCode",{parentName:"p"},"--force")," flag."),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-sh"}),"$ spl-stake-pool update Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR --force\nSignature: 5RneEBwJkFytBJaJdkvCTHFrG3QzE3SGf9vdBm9gteCcHV4HwaHzj3mjX1hZg4yCREQSgmo3H9bPF6auMmMFTSTo\nSignature: 1215wJUY7vj82TQoGCacQ2VJZ157HnCTvfsUXkYph3nZzJNmeDaGmy1nCD7hkhFfxnQYYxVtec5TkDFGGB4e7EvG\n")),Object(r.b)("h3",{id:"withdraw-stake"},"Withdraw stake"),Object(r.b)("p",null,"Whenever the user wants to recover their SOL plus accrued rewards, they can provide their\npool tokens in exchange for an activated stake account."),Object(r.b)("p",null,"Let's withdraw active staked SOL in exchange for 5 pool tokens."),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ spl-stake-pool withdraw-stake Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR 5\nWithdrawing \u25ce5.000000000, or 5 pool tokens, from stake account 3k7Nwu9jUSc6SNG11wzufKYoZXRFgxWamheGLYWp5Rvx, delegated to EhRbKi4Vhm1oUCGWHiLEMYZqDrHwEd7Jgzgi26QJKvfQ\nCreating account to receive stake 5GuAyPAt6577HoGhSVRNBv6aHohVtjQ8q7q5i3X1p4tB\nSignature: 5fzaKt5MU8bLjJRgNZyEktKsgweSQzFRpubCGKPeuk9shNQb4CtTkbgZ2X5MmC1VRDZ3YcCTPdtL9sFpXYfoqaeV\n")),Object(r.b)("p",null,"The stake pool took 5 pool tokens, and in exchange the user received a fully\nactive stake account, delegated to ",Object(r.b)("inlineCode",{parentName:"p"},"EhRbKi4Vhm1oUCGWHiLEMYZqDrHwEd7Jgzgi26QJKvfQ"),".\nLet's double-check the status of the stake account:"),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ solana stake-account 5GuAyPAt6577HoGhSVRNBv6aHohVtjQ8q7q5i3X1p4tB\nBalance: 5.00228288 SOL\nRent Exempt Reserve: 0.00228288 SOL\nDelegated Stake: 5 SOL\nActive Stake: 5 SOL\nDelegated Vote Account Address: EhRbKi4Vhm1oUCGWHiLEMYZqDrHwEd7Jgzgi26QJKvfQ\nStake Authority: 4SnSuUtJGKvk2GYpBwmEsWG53zTurVM8yXGsoiZQyMJn\nWithdraw Authority: 4SnSuUtJGKvk2GYpBwmEsWG53zTurVM8yXGsoiZQyMJn\n")),Object(r.b)("p",null,"Note: this operation cost the user some funds, as they needed to create a new\nstake account with the minimum rent exemption in order to receive the funds. This\nallows the user to withdraw any amount of stake pool tokens, even if it is not\nenough to cover the stake account rent-exemption."),Object(r.b)("p",null,"Alternatively, the user can specify an existing uninitialized stake account to\nreceive their stake using the ",Object(r.b)("inlineCode",{parentName:"p"},"--stake-receiver")," parameter."),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ spl-stake-pool withdraw-stake Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR  --amount 0.02 --vote-account EhRbKi4Vhm1oUCGWHiLEMYZqDrHwEd7Jgzgi26QJKvfQ --stake-receiver CZF2z3JJoDmJRcVjtsrz1BKUUGNL3VPW5FPFqge1bzmQ\nWithdrawing \u25ce5.000000000, or 5 pool tokens, from stake account 3k7Nwu9jUSc6SNG11wzufKYoZXRFgxWamheGLYWp5Rvx, delegated to EhRbKi4Vhm1oUCGWHiLEMYZqDrHwEd7Jgzgi26QJKvfQ\nSignature: 2xBPVPJ749AE4hHNCNYdjuHv1EdMvxm9uvvraWfTA7Urrvecwh9w64URCyLLroLQ2RKDGE2QELM2ZHd8qRkjavJM\n")),Object(r.b)("p",null,"By default, the withdraw command uses the ",Object(r.b)("inlineCode",{parentName:"p"},"token-owner"),"'s associated token account to\nsource the pool tokens. It's possible to specify the SPL token account using\nthe ",Object(r.b)("inlineCode",{parentName:"p"},"--pool-account")," flag."),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ spl-stake-pool withdraw-stake Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR 5 --pool-account 34XMHa3JUPv46ftU4dGHvemZ9oKVjnciRePYMcX3rjEF\nWithdrawing \u25ce5.000000000, or 5 pool tokens, from stake account 3k7Nwu9jUSc6SNG11wzufKYoZXRFgxWamheGLYWp5Rvx, delegated to EhRbKi4Vhm1oUCGWHiLEMYZqDrHwEd7Jgzgi26QJKvfQ\nCreating account to receive stake CZF2z3JJoDmJRcVjtsrz1BKUUGNL3VPW5FPFqge1bzmQ\nSignature: 2xBPVPJ749AE4hHNCNYdjuHv1EdMvxm9uvvraWfTA7Urrvecwh9w64URCyLLroLQ2RKDGE2QELM2ZHd8qRkjavJM\n")),Object(r.b)("p",null,"By default, the withdraw command will withdraw from the largest validator stake\naccounts in the pool. It's also possible to specify a specific vote account for\nthe withdraw using the ",Object(r.b)("inlineCode",{parentName:"p"},"--vote-account")," flag."),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ spl-stake-pool withdraw-stake Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR  --amount 5 --vote-account EhRbKi4Vhm1oUCGWHiLEMYZqDrHwEd7Jgzgi26QJKvfQ\nWithdrawing \u25ce5.000000000, or 5 pool tokens, from stake account 3k7Nwu9jUSc6SNG11wzufKYoZXRFgxWamheGLYWp5Rvx, delegated to EhRbKi4Vhm1oUCGWHiLEMYZqDrHwEd7Jgzgi26QJKvfQ\nCreating account to receive stake CZF2z3JJoDmJRcVjtsrz1BKUUGNL3VPW5FPFqge1bzmQ\nSignature: 2xBPVPJ749AE4hHNCNYdjuHv1EdMvxm9uvvraWfTA7Urrvecwh9w64URCyLLroLQ2RKDGE2QELM2ZHd8qRkjavJM\n")),Object(r.b)("p",null,"Note that the associated validator stake account must have enough lamports to\nsatisfy the pool token amount requested."),Object(r.b)("h4",{id:"special-case-exiting-pool-with-a-delinquent-staker"},"Special case: exiting pool with a delinquent staker"),Object(r.b)("p",null,"With the reserve stake, it's possible for a delinquent or malicious staker to\nmove all stake into the reserve through ",Object(r.b)("inlineCode",{parentName:"p"},"decrease-validator-stake"),", so the\npool tokens will not gain rewards, and the stake pool users will not\nbe able to withdraw their funds."),Object(r.b)("p",null,"To get around this case, it is also possible to withdraw from the stake pool's\nreserve, but only if all of the validator stake accounts are at the minimum amount of\n",Object(r.b)("inlineCode",{parentName:"p"},"0.001 SOL + stake account rent exemption"),"."),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-console"}),"$ spl-stake-pool withdraw-stake Zg5YBPAk8RqBR9kaLLSoN5C8Uv7nErBz1WC63HTsCPR 5 --use-reserve\nWithdrawing \u25ce5.000000000, or 5 pool tokens, from stake account J5XB7mWpeaUZxZ6ogXT57qSCobczx27vLZYSgfSbZoBB\nCreating account to receive stake 51XdXiBSsVzeuY79xJwWAGZgeKzzgFKWajkwvWyrRiNE\nSignature: yQH9n7Go6iCMEYXqWef38ZYBPwXDmbwKAJFJ4EHD6TusBpusKsfNuT3TV9TL8FmxR2N9ExZTZwbD9Njc3rMvUcf\n")),Object(r.b)("h2",{id:"appendix"},"Appendix"),Object(r.b)("h3",{id:"activated-stakes"},"Activated stakes"),Object(r.b)("p",null,"As mentioned earlier, the stake pool only processes active stakes. This feature\nmaintains fungibility of stake pool tokens. Fully activated stakes\nare not equivalent to inactive, activating, or deactivating stakes due to the\ntime cost of staking. Otherwise, malicious actors can deposit stake in one state\nand withdraw it in another state without waiting."),Object(r.b)("h3",{id:"transient-stake-accounts"},"Transient stake accounts"),Object(r.b)("p",null,"Each validator gets one transient stake account, so the staker can only\nperform one action at a time on a validator. It's impossible to increase\nand decrease the stake on a validator at the same time. The staker must wait for\nthe existing transient stake account to get merged during an ",Object(r.b)("inlineCode",{parentName:"p"},"update")," instruction\nbefore performing a new action."),Object(r.b)("h3",{id:"reserve-stake-account"},"Reserve stake account"),Object(r.b)("p",null,"Every stake pool is initialized with an undelegated reserve stake account, used\nto hold undelegated stake in process of rebalancing. After the staker decreases\nthe stake on a validator, one epoch later, the update operation will merge the\ndecreased stake into the reserve. Conversely, whenever the staker increases the\nstake on a validator, the lamports are drawn from the reserve stake account."),Object(r.b)("h3",{id:"safety-of-funds"},"Safety of Funds"),Object(r.b)("p",null,"One of the primary aims of the stake pool program is to always allow pool token\nholders to withdraw their funds at any time."),Object(r.b)("p",null,"To that end, let's look at the three classes of stake accounts in the stake pool system:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"validator stake: active stake accounts, one per validator in the pool"),Object(r.b)("li",{parentName:"ul"},"transient stake: activating or deactivating stake accounts, merged into the reserve after deactivation, or into the validator stake after activation, one per validator"),Object(r.b)("li",{parentName:"ul"},"reserve stake: inactive stake, to be used by the staker for rebalancing")),Object(r.b)("p",null,'Additionally, the staker may set a "preferred withdraw account", which forces users\nto withdraw from a particular stake account.  This is to prevent malicious\ndepositors from using the stake pool as a free conversion between validators.'),Object(r.b)("p",null,"When processing withdrawals, the order of priority goes:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"preferred withdraw validator stake account (if set)"),Object(r.b)("li",{parentName:"ul"},"validator stake accounts"),Object(r.b)("li",{parentName:"ul"},"transient stake accounts"),Object(r.b)("li",{parentName:"ul"},"reserve stake account")),Object(r.b)("p",null,"If there is preferred withdraw validator, and that validator stake account has\nany SOL, a user must withdraw from that account."),Object(r.b)("p",null,"If that account is empty, or the preferred withdraw validator stake account is\nnot set, then the user must withdraw from any validator stake account."),Object(r.b)("p",null,"If all validator stake accounts are empty, which may happen if the stake pool\nstaker decreases the stake on all validators at once, then the user must withdraw\nfrom any transient stake account."),Object(r.b)("p",null,"If all transient stake accounts are empty, then the user must withdraw from the\nreserve."),Object(r.b)("p",null,"In this way, a user's funds are never at risk, and always redeemable."),Object(r.b)("h3",{id:"transaction-sizes"},"Transaction sizes"),Object(r.b)("p",null,"The Solana transaction processor has two important limitations:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"size of the overall transaction, limited to roughly 1 MTU / packet"),Object(r.b)("li",{parentName:"ul"},"computation budget per instruction")),Object(r.b)("p",null,"A stake pool may manage hundreds of staking accounts, so it is impossible to\nupdate the total value of the stake pool in one instruction. Thankfully, the\ncommand-line utility breaks up transactions to avoid this issue for large pools."))}p.isMDXComponent=!0},155:function(e,t,a){"use strict";a.d(t,"a",(function(){return d})),a.d(t,"b",(function(){return h}));var n=a(0),o=a.n(n);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function s(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?s(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):s(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,o=function(e,t){if(null==e)return{};var a,n,o={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(o[a]=e[a]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var c=o.a.createContext({}),p=function(e){var t=o.a.useContext(c),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},d=function(e){var t=p(e.components);return o.a.createElement(c.Provider,{value:t},e.children)},b={inlineCode:"code",wrapper:function(e){var t=e.children;return o.a.createElement(o.a.Fragment,{},t)}},u=o.a.forwardRef((function(e,t){var a=e.components,n=e.mdxType,r=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),d=p(a),u=n,h=d["".concat(s,".").concat(u)]||d[u]||b[u]||r;return a?o.a.createElement(h,i(i({ref:t},c),{},{components:a})):o.a.createElement(h,i({ref:t},c))}));function h(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var r=a.length,s=new Array(r);s[0]=u;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i.mdxType="string"==typeof e?e:n,s[1]=i;for(var c=2;c<r;c++)s[c]=a[c];return o.a.createElement.apply(null,s)}return o.a.createElement.apply(null,a)}u.displayName="MDXCreateElement"}}]);